"use strict";angular.module("myApp.controllers",[]).controller("AppCtrl",["$scope","USER_ROLES","AUTH_EVENTS","$rootScope","AuthService","modalService","Session","Restangular","$state",function(e,t,i,n,o,r,a,s,l){e.currentUser=null,e.userRoles=t,e.isAuthorized=o.isAuthorized,e.go=function(e){l.go(e)},n.$on(i.loginSuccess,function(){e.currentUser=a.nome_breve_utenti,s.setDefaultRequestParams({apiKey:a.token})}),n.$on(i.loginFailed,function(){r.showModal({},{type:2,closeButtonText:"Cancel",actionButtonText:"Ok",headerText:"Login errato",bodyText:"Immettere nome utente e password corrette"}).then(function(){})}),n.$on(i.notAuthenticated,function(){e.currentUser=a.nome_breve_utenti,r.showModal({},{type:2,closeButtonText:"Cancel",actionButtonText:"Ok",headerText:"Utente non autenticato",bodyText:"Immettere nome utente e password dalla pagina home"}).then(function(){})}),n.$on("$stateChangeStart",function(e,t){t.accessLogged&&(o.isAuthenticated()||(e.preventDefault(),n.$broadcast(i.notAuthenticated)))})}]).controller("EditItemCtrl",["$scope","$state","$stateParams","Restangular","modalService","rService","Session",function(e,t,i,n,o,r,a){var s=t.current.configAction;if(e.configAction=s,e.item={},e.openedPopupDate=!1,"edit"==s||"view"==s){var l=n.all("serviziAll");l.getList({limit:50,id_servizi_selezione:i.id}).then(function(t){e.item=t[0],e.item.a_ora_servizi=new Date(t[0].a_ora_servizi),e.item.da_ora_servizi=new Date(t[0].da_ora_servizi),e.timeCalculated=r.time_diff(e.item.da_ora_servizi,e.item.a_ora_servizi)})}if("new"==s){var u={id_utenti:1,id_volontari_servizi:0,data_servizi:new Date,da_ora_servizi:new Date("1900-01-01T08:30:00.000Z"),a_ora_servizi:new Date("1900-01-01T10:30:00.000Z"),note_servizi:"",rapporto_servizi:""};e.item=u,e.timeCalculated=r.time_diff(new Date("1900-01-01T08:15:00.000Z"),new Date("1900-01-01T19:33:00.000Z"))}if(a.isAdmin){var c=n.all("utentiAll");c.getList().then(function(t){e.utentiList=t})}else e.utentiList=[],e.utentiList.push({id_utenti:a.id_utenti,nome_breve_utenti:a.nome_breve_utenti}),e.item.id_utenti=a.id_utenti;var _=n.all("volontariAll");_.getList().then(function(t){e.volontariList=t}),e.master={},e.timeCalculated=0,e.timechanged=function(){e.timeCalculated=r.time_diff(e.item.da_ora_servizi,e.item.a_ora_servizi)},e.cancel_action=function(e){o.showModal({},{type:1,closeButtonText:"Indietro",actionButtonText:"Ok - Elimina!",headerText:"Messaggio",bodyText:"Eliminare il presente servizio?"}).then(function(){n.oneUrl("servizi","/api1/servizi/"+e.id_servizi).get().then(function(i){i.annullato_servizi=1,n.setBaseUrl("/api1"),i.customPUT({annullato_servizi:1},e.id_servizi,{},{}),n.setBaseUrl("/apiQ"),t.go("list")})})},e.save_action=function(){var i="";if(e.item.a_ora_servizi<=e.item.da_ora_servizi&&(i="Orario servizi errato!"),0==e.item.id_volontari_servizi&&(i="Selezionare un volontario!"),e.item.data_servizi<new Date&&(i="Non Ã¨ possibile selezionare date del servizio precedenti a quelle odierna."),""!=i)o.showModal({},{type:2,closeButtonText:"Cancel",actionButtonText:"Ok",headerText:"Errori di inserimento dati!",bodyText:i}).then(function(){});else{var r={id_volontari_servizi:e.item.id_volontari_servizi,data_servizi:e.item.data_servizi,da_ora_servizi:e.item.da_ora_servizi,a_ora_servizi:e.item.a_ora_servizi,note_servizi:e.item.note_servizi,rapporto_servizi:e.item.rapporto_servizi},a=n.allUrl("servizi","/api1/servizi");a.post(r).then(function(e){var i={type:1,headerText:"Messaggio",bodyText:"Dato inserito con successo"};o.showModal({},i).then(function(){t.go("view",{id:e.id_servizi})},function(){t.go("view",{id:e.id_servizi})})},function(){})}},e.popupDate=function(t){t.preventDefault(),t.stopPropagation(),e.openedPopupDate=e.openedPopupDate?!1:!0},e.$watch("item.id_utenti",function(t){var i=n.all("volontariAll");i.getList({id_volontari_utenti:t}).then(function(t){e.volontariList=t})})}]).controller("InfiniteCtrl",["$scope","$location","Restangular","$filter","Session",function(e,t,i,n,o){e.totalPages=0,e.itemsCount=0,e.currentPage=1,e.totalItems=0,e.pageSize=8,e.startPage=0,e.openedPopupDate=!1,e.utentiList=[],e.filterCriteria={pageNumber:1,count:0,limit:e.pageSize,start:0,sortDir:"asc",sortedBy:"id",id_utenti_selezione:o.isAdmin?0:o.id_utenti,mese_selezione:0,anno_selezione:0};var r=i.all("utentiAll");r.getList().then(function(t){o.isAdmin?(e.utentiList=t,e.utentiList.push({id_utenti:0,nome_breve_utenti:"TUTTI"}),e.id_utenti_selezione=0):(e.id_utenti_selezione=o.id_utenti,e.filterCriteria.id_utenti_selezione=o.id_utenti,e.utentiList=[],e.utentiList.push({id_utenti:o.id_utenti,nome_breve_utenti:o.nome_breve_utenti}))}),e.fetchResult=function(){var t=i.all("serviziAll");e.filterCriteria.count=1,t.getList(e.filterCriteria).then(function(t){e.totalItems=t.length>0?t[0].totalItems:0},function(){e.totalItems=0});var n=(e.currentPage-1)*e.pageSize;return e.filterCriteria.count=0,e.filterCriteria.start=n,t.getList(e.filterCriteria).then(function(t){e.items=t},function(){e.items=[]})},e.selectPage=function(){var t=e.currentPage;e.currentPage=t,e.filterCriteria.pageNumber=t,e.fetchResult()},e.selectPage(1),e.$watch("id_utenti_selezione",function(t){o.isAdmin&&(e.filterCriteria.id_utenti_selezione=t,e.currentPage=1,e.filterCriteria.pageNumber=e.currentPage,e.fetchResult())}),e.$watch("data_servizi_selezione",function(t){t?(e.filterCriteria.mese_selezione=n("date")(t,"MM"),e.filterCriteria.anno_selezione=n("date")(t,"yyyy")):(e.filterCriteria.mese_selezione=0,e.filterCriteria.anno_selezione=0),e.currentPage=1,e.filterCriteria.pageNumber=e.currentPage,e.fetchResult()}),e.popupDate=function(t){t.preventDefault(),t.stopPropagation(),e.openedPopupDate=e.openedPopupDate?!1:!0},e.editItem=function(e){t.path("/edit/"+e)}}]).controller("ReportCtrl",["$scope","Restangular","modalService","rService","$filter","$http","$sce","Session",function(e,t,i,n,o,r,a,s){if(e.timeCalculated=0,e.item={},e.item.tipo_report=1,e.openedPopupDate=!1,s.isAdmin){var l=t.all("utentiAll");l.getList().then(function(t){e.utentiList=t,e.utentiList.push({id_utenti:0,nome_breve_utenti:"TUTTI"})})}else e.utentiList=[],e.utentiList.push({id_utenti:s.id_utenti,nome_breve_utenti:s.nome_breve_utenti}),e.item.id_utenti=s.id_utenti;var u=t.all("volontariAll");u.getList().then(function(t){e.volontariList=t}),e.timechanged=function(){e.timeCalculated=n.time_diff(e.item.da_ora_servizi,e.item.a_ora_servizi)},e.popupDate=function(t){t.preventDefault(),t.stopPropagation(),e.openedPopupDate=e.openedPopupDate?!1:!0},e.build_report=function(){var t="";if(e.item.id_utenti||(t="Selezionare una Associazione"),e.item.data_servizi||(t="Selezionare una data!"),""!=t)i.showModal({},{closeButtonText:"Cancel",actionButtonText:"Ok",headerText:"Errori di inserimento dati!",bodyText:t}).then(function(){});else{var n,r={id_utenti:e.item.id_utenti,tipo_report:e.item.tipo_report,data_servizi:e.item.data_servizi,relazione_servizio:e.item.relazione_servizio,utenti_controllati:e.item.utenti_controllati,dati_auto:e.item.dati_auto,giorno_servizi:o("date")(e.item.data_servizi,"dd"),mese_servizi:o("date")(e.item.data_servizi,"MM"),anno_servizi:o("date")(e.item.data_servizi,"yyyy")},a=(JSON.stringify(r),"");for(n in r){if(!r.hasOwnProperty(n))return;0!==a.length&&(a+="&"),a+=n+"="+encodeURIComponent(r[n])}var s="/pdf/?"+a;new PDFObject({url:s}).embed("PDF_DIV_CONTAINER")}},e.$watch("item.data_servizi",function(i){var n=t.all("serviziAll");n.getList({limit:50,id_utenti_selezione:e.item.id_utenti,mese_selezione:o("date")(i,"MM"),anno_selezione:o("date")(i,"yyyy")}).then(function(t){e.serviziList=[];for(var i=0;i<t.length;i++)t[i].nome_volontario_completo=t[i].nome_volontari+" "+t[i].cognome_volontari,e.serviziList.push(t[i])})}),e.$watch("item.id_utenti",function(i){var n=t.all("volontariAll");n.getList({id_volontari_utenti:i}).then(function(t){e.volontariList=t})})}]).controller("LoginController",["$scope","$rootScope","AUTH_EVENTS","AuthService",function(e,t,i,n){e.credentials={username:"",password:""},e.login=function(e){n.login(e).then(function(){t.$broadcast(i.loginSuccess)},function(){t.$broadcast(i.loginFailed)})},e.logout=function(e){n.logout(e).then(function(){t.$broadcast(i.loginSuccess)},function(){t.$broadcast(i.loginFailed)})}}]).controller("TestController",["$scope","Session","Restangular","$rootScope","$modal","$filter","$location",function(e,t,i,n,o,r,a){e.totalPages=0,e.itemsCount=0,e.currentPage=1,e.totalItems=0,e.pageSize=3,e.startPage=0,e.openedPopupDate=!1,e.utentiList=[],e.filterCriteria={pageNumber:1,count:0,limit:e.pageSize,start:0,sortDir:"asc",sortedBy:"id",id_utenti_selezione:0,mese_selezione:0,anno_selezione:0};var s=i.all("utentiAll");s.getList().then(function(i){t.isAdmin?(e.utentiList=i,e.utentiList.push({id_utenti:0,nome_breve_utenti:"TUTTI"}),e.id_utenti_selezione=0):(e.id_utenti_selezione=t.id_utenti,e.utentiList=[],e.utentiList.push({id_utenti:t.id_utenti,nome_breve_utenti:t.nome_breve_utenti}))}),e.fetchResult=function(){var t=i.all("serviziAll");e.filterCriteria.count=1,t.getList(e.filterCriteria).then(function(t){e.totalItems=t.length>0?t[0].totalItems:0},function(){e.totalItems=0});var n=(e.currentPage-1)*e.pageSize;return e.filterCriteria.count=0,e.filterCriteria.start=n,t.getList(e.filterCriteria).then(function(t){e.items=t},function(){e.items=[]})},e.selectPage=function(){var t=e.currentPage;e.currentPage=t,e.filterCriteria.pageNumber=t,e.fetchResult()},e.selectPage(1),e.$watch("id_utenti_selezione",function(i){t.isAdmin&&(e.filterCriteria.id_utenti_selezione=i,e.currentPage=1,e.filterCriteria.pageNumber=e.currentPage,e.fetchResult())}),e.$watch("data_servizi_selezione",function(t){t?(e.filterCriteria.mese_selezione=r("date")(t,"MM"),e.filterCriteria.anno_selezione=r("date")(t,"yyyy")):(e.filterCriteria.mese_selezione=0,e.filterCriteria.anno_selezione=0),e.currentPage=1,e.filterCriteria.pageNumber=e.currentPage,e.fetchResult()}),e.popupDate=function(t){t.preventDefault(),t.stopPropagation(),e.openedPopupDate=e.openedPopupDate?!1:!0},e.editItem=function(e){a.path("/edit/"+e)},e.items=["item1","item2","item3"];var l=function(e,t,i){e.items=i,e.selected={item:e.items[0]},e.ok=function(){t.close(e.selected.item)},e.cancel=function(){t.dismiss("cancel")}};e.open=function(t){var i=o.open({templateUrl:"myModalContent.html",controller:l,size:t,resolve:{items:function(){return e.items}}});i.result.then(function(t){e.selected=t},function(){})}}]);